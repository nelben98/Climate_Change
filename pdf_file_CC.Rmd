---
title: "European study of emissions and energy generation"
output: pdf_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(openxlsx)
library(tibble)
library(forcats)
library(scales)
library(viridis)
library(cols4all)
library(maps)
library(mapproj)
library(ftplottools)
library(shiny)
```

Introduction - Disclaimer! : 


The aim of this piece is to detail the energy sources in the European countries, while also looking at how much emissions are generated by each country. Furthermore, in an ambitious attempt to contextualize it the background will be enhanced with a detail of the production and consumption of energy by different sectors and industries. Different data sets have been tried to reconcile, and while there are some issues, the general message is still informative. The whole code for this report, as well as the data used, can be seen online in [Github](https://github.com/nelben98/Climate_Change).


# Who runs the world? - Oil

As the world draws plans to phase out oil and coal, it might seem that we've reached the tipping point where polluting fuels are facing a steep decline. But despite the efforts to switch towards renewables and the ESG revolution, Europe still largely depends on oil, gas and coal both as energy and electricity production means.

The IPCC report signaled a few weeks back how the world's rise in temperature was propelling worse-than-expected consequences, not only with relation to  nature but also from a socio-economic standpoint, affecting communities more severely than expected. Moreover, Europe has committed to be the first net zero continent by 2050, phasing out it's heavy gas and oil reliability.

While the pandemic noticeably slowed down general energy consumption, consumption and GDPs of european countries have rebounded back strongly, recovering from the economic shock, although this has brought it's own woes - heavy inflationary trends specially driven by the demand for goods and largely due to energy prices, up by roughly 70% relative to last year.

This trend is increasingly worrying, as some markets are signalling even higher higher spikes [like a 1000% spike since early-pandemic levels in the european gas prices.](https://www.iea.org/data-and-statistics/charts/evolution-of-energy-prices-oct-2020-jan-2022)

However, Europe is still forced to produce energy using fossil fuels, as it has only managed to increase relative renewable production by 4% in the last 3 years to 2021 and its nuclear power capacity stands at less than 6% total energy production as of last year. 

Early 2021 reports, may suggest that some change is ongoing, although slow. In the first half of 2021 the EU-27 is expected to have produced 66% of its electricity consumption from non-fossil fuel sources, dropping coal consumption by 16%, according to this [EMBER REPORT.](https://ember-climate.org/project/european-electricity-review-h1-2021/)

Nonetheless, conflict in Ukraine is not only leading to fossil fuel price rise but possibly also at a rise in the prices of nuclear, as Russia is the biggest exporter of enriched uranium, currently holding 9% of the world's resources.

As gas and oil prices reach historic maxima, Europe is most likely to look back into their own grid and energy supply structures and hopefully speed up investments in fuel alternatives. 


```{r Load data, include=FALSE, message=FALSE}
#Energy/ electricity production
data_supply_raw<-read.csv("Data/data_en_supp.csv")%>% select(-c(freq,unit,nrg_bal,OBS_FLAG,DATAFLOW,LAST.UPDATE)) %>%mutate_at(., "OBS_VALUE", ~replace(., is.na(.), 0))%>% mutate (OBS_VALUE=OBS_VALUE/85.985*1000)

data_prod_raw<-read.csv("Data/data_en_cons.csv") %>% select(-c(freq,unit,nrg_bal,OBS_FLAG,DATAFLOW,LAST.UPDATE)) %>%  mutate_at(., "OBS_VALUE", ~replace(., is.na(.), 0)) %>% mutate (OBS_VALUE=OBS_VALUE/85.985*1000)

elec_prod<-read.csv("Data/energy_prod_monthly_europe.csv") %>% select(-c(freq,unit,OBS_FLAG,DATAFLOW,LAST.UPDATE))%>%filter(siec!="RA410",siec!="RA420",siec!="RA320",siec!="RA310",siec!="RA110",siec!="RA120",siec!="RA130")

# Division by sectors and performances:

dictionary_countries <- data.frame(readRDS("Data/country_codenames.rds"))
colnames(dictionary_countries)<- c("Country_codes","Country")

dictionary_countries <- dictionary_countries %>% mutate(Country=ifelse(Country=="United Kingdom (Convention)","United Kingdom",Country),Country_codes=ifelse(Country_codes=="GR","EL",Country_codes))

#Emissions by country:
eur_em<-read.xlsx("Data/EU_co2_emiss.xlsx")
eur_em_predict<-read.csv("Data/EU_co2_emiss_proj.csv") %>% select(-c(Reported.Value,RY.calibration,SubmissionYear))

selection_countries<- dictionary_countries %>% filter(Country != "United Kingdom (Convention)",Country !="EU (KP)",Country !="EU (KP)",Country !="EU-27",Country!="EU-27+UK")


#Energy prod broken down by products and countries:
# w_sec_count_em<- read.xlsx("Data/Energy_production_country_sector.xlsx") %>% filter(Country %in% selection_countries$Country)
# saveRDS(w_sec_count_em,"Data/energy_sector_country.rds")
w_sec_count_em<-readRDS("Data/energy_sector_country.rds")
## There's also the investment file which is to be used on a more discretionary manner not as a whole don't open but it's the full file:
#poll<-read.csv("Data/pollution_by_country.csv") --- not really needed anymore.

```


```{r dictionaries, include=FALSE}
dic_2<-data.frame(siec = unique(elec_prod $siec),Fuel=c("Coal & gases","Combustible fuels","Combustible fuels","Biofuels","Natural gas","Nuclear","Oil & petrol","Hydro",
                                                   "Geothermal","Wind","Solar","Other renewables","Total","Other"))
elec_broken<-left_join(dic_2,elec_prod,by="siec") %>% select(-c(siec))

dic_3<-data.frame(siec = unique(elec_prod $siec),Fuel=c("Coal & gases","Combustible fuels","Combustible fuels","Biofuels","Natural gas","Nuclear","Oil & petrol","Renewables","Renewables",
                                                   "Renewables","Renewables","Renewables","Total","Other"))
elec<-left_join(dic_3,elec_prod,by="siec") %>% select(-c(siec))


dictionary<-data.frame(siec=unique(data_prod_raw$siec),Fuel=c("Coal & gases","Coal & gases","Electricity","Natural gas","Heat","Nuclear","Oil & petrol","Peat","Renewables/biofuel","Oil & shale","Total","Non-ren waste"))

data_prod<-left_join(dictionary,data_prod_raw,by="siec")%>% select(-c(siec))

data_prod$TIME_PERIOD<-as.Date(ISOdate(data_prod_raw$TIME_PERIOD+1, 1, 1)) 
elec$TIME_PERIOD<-as.Date(ISOdate(as.integer(format(as.Date(paste(elec$TIME_PERIOD, 1,sep="-")),"%Y"))+1, 1, 1)) 
elec_broken$TIME_PERIOD<-as.Date(paste(elec$TIME_PERIOD, 1,sep="-"))

# data_prod %>% filter(Fuel =="Oil & shale",OBS_VALUE!=0) %>% select(geo,TIME_PERIOD,OBS_VALUE) 

#for elecctricy combine renewables-biofuel & combustible fuels bag into coal & gases

data_prod$Fuel[data_prod$Fuel=="Oil & shale"]="Oil & petrol"

elec <- elec %>% mutate(
  Fuel = ifelse(Fuel == "Combustible fuels","Coal & gases",Fuel ),
  Fuel = ifelse(Fuel == "Renewables" | Fuel == "Biofuels" , "Renewables/biofuel",Fuel )
)


```


```{r data available heads,include=FALSE,echo=FALSE, message=FALSE}
head(data_prod_raw)
head(data_supply_raw)
# From the EEA comission 

head(eur_em)
head(eur_em_predict)

head(w_sec_count_em)
```


```{r plots country,include=FALSE,warning=FALSE, message=FALSE}
#Totals by country, choose whether to breakdown electricity or not:

country_totals_byfuel<- data_prod %>% filter(Fuel != "Total", geo== "EU27_2020",geo!= "EA19")

total_country_totals <- country_totals_byfuel %>% 
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(OBS_VALUE))

ggplot(total_country_totals) + aes(x=TIME_PERIOD, y=Consumed,col =Fuel) + geom_line()


```



```{r include= FALSE}

elec_years <- elec %>% filter(Fuel!= "Total") %>%
  group_by(TIME_PERIOD,Fuel,geo) %>% 
  summarise(OBS_VALUE = sum(OBS_VALUE))

#The grid production:

elec_years %>% filter(geo== "EU27_2020",TIME_PERIOD >= "2018-01-01",TIME_PERIOD<"2022-01-01") %>% select(-geo) %>% 
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(OBS_VALUE))%>% filter(TIME_PERIOD =="2021-01-01") %>%
  arrange(desc(Consumed)) %>%  
  mutate( Fuel=factor(Fuel,levels=Fuel),
          Fuel = fct_collapse(Fuel,"Other"=c("Non-ren waste","Other","Peat","Heat")))%>%
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(Consumed)) %>% mutate(prop= Consumed/sum(Consumed)*100)
```


```{r warning=FALSE, message=FALSE, echo=FALSE}
## Combination elec + productions and plotting:


elec_plus_production<- data.frame(rbind(data_prod%>% filter(Fuel!="Electricity",Fuel!="Total"), elec_years )) %>% filter(geo== "EU27_2020",TIME_PERIOD>= "2018-01-01",TIME_PERIOD<"2022-01-01") %>% select(-geo)


broken_ele_prod <- elec_plus_production %>% 
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(OBS_VALUE))

prop_elec_2020<-broken_ele_prod %>% filter(TIME_PERIOD =="2021-01-01") %>%
  arrange(desc(Consumed)) %>%  
  mutate( Fuel=factor(Fuel,levels=Fuel),
          Fuel = fct_collapse(Fuel,"Other"=c("Non-ren waste","Other","Peat","Heat")))%>%
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(Consumed)) %>% mutate(prop= Consumed/sum(Consumed))

prop_elec_2017<- broken_ele_prod %>% filter(TIME_PERIOD =="2018-01-01") %>%
  arrange(desc(Consumed)) %>%  
  mutate( Fuel=factor(Fuel,levels=Fuel),
          Fuel = fct_collapse(Fuel,"Other"=c("Non-ren waste","Other","Peat","Heat")))%>%
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(Consumed)) %>% mutate(prop= Consumed/sum(Consumed))

preserving_orders<-merge(prop_elec_2020,prop_elec_2017,by="Fuel") %>% arrange(desc(prop.y))

elec_prod_clean<-broken_ele_prod %>% 
  arrange(desc(Consumed)) %>%  
  mutate( Fuel=factor(Fuel,levels=Fuel),
          Fuel = fct_collapse(Fuel,"Other"=c("Non-ren waste","Other","Peat","Heat")))%>%
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(Consumed)) %>% ungroup(TIME_PERIOD,Fuel)


### Electricity and energy consumption

plot<-ggplot(elec_prod_clean,aes(x=TIME_PERIOD, y=Consumed/10**6, fill=Fuel)) + 
            geom_area(alpha=0.6 , size=1, colour="black") +
            labs(x="Year",
                 y=expression(paste('Energy consumed (',10^6,' GWE)')),
                 title="Cummulative energy production of EU-27 (breaking down electricity)") + 
            theme_bw() +
            scale_fill_brewer(palette = "RdYlBu")+ 
            theme(axis.text.x = element_text(angle = 45,hjust=1),panel.grid = element_blank())

plot + annotate("label",
                x = c(rep(as.Date("2021-01-01","%Y-%m-%d"),6)),
                y = c(9.8,6.5,4.5,2.5,1,0.2),
                label = paste(round(preserving_orders$prop.x,3)*100,"%"), 
                color="black", 
                size=2.5 , 
                fontface="bold") +
  annotate("label",
           x = c(rep(as.Date("2018-01-01","%Y-%m-%d"),6)),
           y = c(10.2,6.8,4.7,2.2,1,0.2),
           label = paste(sort(round(prop_elec_2017$prop,3)*100,decreasing=TRUE),"%"), 
           color="black", 
           size=2.5 , 
           fontface="bold")
```


Electricity is not the only concerning factor in terms of cleaning pollution - it only accounts for a quarter of all energy consumed while petrol, gas and coal make up for the majority of production.

Comparing production, nuclear and coal are mainly used in the electricity production, however fossil fuels still run the majority of transports in Europe and natural gas still heats our homes. The energy transition will not only have to be focused in cleaning the grid but most critically should be sector wide.


```{r With electricity as factor, warning=FALSE, message=FALSE, echo= FALSE}
energy_w_elec<- data.frame(data_prod) %>% 
  filter(geo== "EU27_2020",Fuel!="Total") %>% 
  select(-geo)

energy_w_elec <- energy_w_elec %>% 
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(OBS_VALUE))

energy_at_2020 <- energy_w_elec %>% filter(TIME_PERIOD =="2021-01-01") %>%
  arrange(desc(Consumed)) %>%  
  mutate( Fuel=factor(Fuel,levels=Fuel),
          Fuel = fct_collapse(Fuel,"Other"=c("Non-ren waste","Other","Peat","Heat")))%>%
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(Consumed)) %>% mutate(prop= Consumed/sum(Consumed))

energy_at_2017 <- energy_w_elec %>% filter(TIME_PERIOD =="2018-01-01") %>%
  arrange(desc(Consumed)) %>%  
  mutate( Fuel=factor(Fuel,levels=Fuel),
          Fuel = fct_collapse(Fuel,"Other"=c("Non-ren waste","Other","Peat","Heat")))%>%
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(Consumed)) %>% mutate(prop= Consumed/sum(Consumed))

preserving_orders<-merge(energy_at_2020,energy_at_2017,by="Fuel") %>% arrange(desc(prop.y))

prod_clean<-energy_w_elec %>% 
  arrange(desc(Consumed)) %>%  
  mutate( Fuel=factor(Fuel,levels=Fuel),
          Fuel = fct_collapse(Fuel,"Other"=c("Non-ren waste","Other","Peat","Heat")))%>%
  group_by(TIME_PERIOD,Fuel) %>%
  summarise(Consumed = sum(Consumed)) %>% ungroup(TIME_PERIOD,Fuel)

### Energy consumption + electricity: 

plot_2<-ggplot(prod_clean,aes(x=TIME_PERIOD, y=Consumed/10**6, fill=Fuel)) + 
              geom_area(alpha=0.6 , size=1, colour="black") + 
            labs(x="Year",
                 y=expression(paste('Energy consumed (',10^6,' GWE)')),
                 title="Cummulative energy production EU-27 - inc. electricity") + 
            theme_bw() +
            scale_fill_brewer(palette = "RdYlBu") + 
            theme(axis.text.x = element_text(angle = 45,hjust=1),panel.grid = element_blank())

plot_2 + annotate("label",x = c(rep(as.Date("2021-01-01","%Y-%m-%d"),6)),
                   y = c(9,5.2,3,1.5,0.6,0),
                   label = paste(round(preserving_orders$prop.x,3)*100,"%"), color="black", 
                    size=2.5 , fontface="bold") +
  annotate("label",x = c(rep(as.Date("2012-01-01","%Y-%m-%d"),6)),
                   y = c(9,5.2,3,1.5,0.6,0),
                   label = paste(sort(round(preserving_orders$prop.y,3)*100,decreasing=TRUE),"%"), color="black", 
                   size=2.5 , fontface="bold")
```

Some key elements stand out in the make-up of energy production in these economies, for instance whilst Nuclear is seen as a valuable resource in France, Italy has historically shun it. 

Likewise, Germany has a very small nuclear production, relying in oil and gas as energy providers. Moreover, the German government has promised the decommission of all its nuclear plants by the end of 2022, with no renewable energy resources lined up to pick up the spare capacity generated.

Although in Germany's case the North stream pipeline - connecting Germany directly with Russian's gas supplies- might have been a suitable substitute for the nuclear phase-out the current situation in Russia has underlined how volatile dependence on Russia would be for European countries.

The northern countries, Finland and Sweden generate the most proportion of their energy from renewables out of all European countries. Although no data is available in the European databases, Norway similarly has a greener energy mix to their neighboring countries.

Overall, the lack of growth in either Nuclear nor renewables in the European economies in the recent years, creates a concerning scenario about the real extend to which net zero by 2050 can be reached.

```{r, message=FALSE, include=FALSE}
## Only electricity - use shiny to extend by country and year::

Total_ele_2020<- elec %>% filter(TIME_PERIOD=="2021-01-01",geo=="DE")
elec_2020 <- data.frame(tapply(Total_ele_2020$OBS_VALUE,list(Total_ele_2020$Fuel), function(x) {sum(x,na.rm=TRUE)}))
summ_elec_1<-data.frame(Consumed=tapply(Total_ele_2020$OBS_VALUE,list(Total_ele_2020$Fuel), function(x) {sum(x,na.rm=TRUE)}))
summ_elec_2020_s<-rownames_to_column(summ_elec_1,"Fuel")

summ_elec_2020_s %>% filter(Fuel!= "Total")%>% arrange(desc(Consumed)) %>% mutate(Fuel=factor(Fuel,levels=Fuel)) %>% ggplot(.,aes(x=Fuel,y=Consumed)) + geom_col() + theme(axis.text.x = element_text(angle = 45,hjust=1))

```

- Production of the 5 largest Euro countries by GDP - Germany, France, Italy, Spain and Poland

```{r warning=FALSE, message=FALSE, echo=FALSE}

main_energy_geo <- data.frame(rbind(data_prod %>% 
                   filter(Fuel!="Electricity",Fuel!="Total"), elec_years )) %>% 
                   mutate( Fuel= as.factor(Fuel),
                           Fuel = fct_collapse(Fuel,"Other"=c("Non-ren waste","Other","Peat","Heat"))) %>% 
                   filter(TIME_PERIOD>= "2018-01-01",TIME_PERIOD<"2022-01-01",geo %in% c("FR","DE","IT","ES","PL"))%>%
                   group_by(geo,TIME_PERIOD,Fuel) %>%
                   summarise(Consumed = sum(OBS_VALUE)) %>%
                   ungroup(Fuel,TIME_PERIOD) %>%
                   mutate(TIME_PERIOD)%>%
                   arrange(desc(Consumed)) %>% drop_na(Consumed)

main_energy_geo$geo =  with(main_energy_geo, reorder(geo, Consumed, FUN= function(x){1/sum(x)}))

p <- ggplot(main_energy_geo, aes(geo, Consumed/1000, label = geo, fill = Fuel)) + 
     geom_bar(stat="identity") + 
     facet_wrap( ~ format(TIME_PERIOD,"%Y"), scales="free")+
     labs(x="Year and country",
          y=expression(paste('Energy consumed (',10^6,' GWE)')),
          title="Energy production") +
    theme_bw() + 
    scale_y_continuous(limits=c(0,2500))

p + scale_fill_brewer(palette = "RdYlBu") + theme(axis.text.x = element_text(angle = 45,hjust=1))

```


```{r error file, include=FALSE}
#For errors:
## em_sector<- read.csv("Data/emissions_by_sector.csv")

# read.csv("Data/emissions_by_sector.csv") %>% filter(Country_code %in% selection_countries$Country_code)

## em_sector_1 <- em_sector %>% filter(Country_code %in% c("EUA","EUX","EUC")) %>% arrange(Year)
## saveRDS(em_sector_1,"Data/sector_breakdown.rds")

#em_sector <- readRDS("Data/sector_breakdown.rds")
#em_sector_1<- em_sector %>% filter(Sector_name %in% c("1 - Energy","1.A.1 - Energy Industries",
                                                     #"1.A.2 - Manufacturing Industries and Construction",
                 #                                    "1.A.3 - Transport",
                  #                                   "1.A.3.a - Domestic Aviation",
                   #                                  "1.A.3.b - Road Transportation",
                    #                                 "1.A.3.b.i - Cars",
                     #                                "1.A.3.b.ii - Light duty trucks",
                      #                               "1.A.3.b.iii - Heavy duty trucks and buses",
                       #                              "1.A.3.b.iv - Motorcycles",
                        #                             "1.A.3.b.v - Other Road Transportation",
                         #                            "1.A.3.c - Railways",
                          #                           "1.A.3.d - Domestic Navigation",
                           #                          "1.A.3.e - Other Transportation",
                            #                         "1.A.4 - Other Sectors",
                             #                        "1.A.4.a - Commercial/Institutional",
                              #                       "1.A.4.b - Residential",
                               #                      "1.A.4.c - Agriculture/Forestry/Fishing",
                                #                     "1.A.5 - Other Other Sectors",
                                 #                    "2 - Industrial Processes and Product Use",
                                  #                   "2.A - Mineral Industry",
                                   #                  "2.B - Chemical Industry",
                                    #                 "2.C - Metal Industry",
                                     #                "2.D - Non-energy Products from Fuels and Solvent Use",
                                      #               "2.E - Electronics Industry",
                                       #              "2.F - Product Uses as Substitutes for ODS",
                                        #             "3 - Agriculture",
                                         #            "Total emissions (UNFCCC)",
                                          #           "Total emissions with international aviation (EU 2020)"
                                           #          ))

# saveRDS(em_sector_1,"Data/sectors_breakdown.rds")

```


An encouraging factor is the efficiency gains seemingly happening in the energy supply sector, where despite providing growing amounts of energy the total emissions recorded have been steadily falling for the last 10 years.

The same cannot be said from transport, where cars have clearly maintained the trend and still dominate, polluting for over 50% of the total transport sector. These trend was first seen falling at the end of the Great Recession, however post-2012 the trend for both cars and Heavy truck traffic has been picking up again.

European countries have been clamping down on petrol and diesel cars, with the UK setting 2030 as the latest date of sale, while France or Germany have set 2035 as their deadlines. However, greener transport does also involve a greener production of electricity.

While the spotlight has been laid on the car industry and the consumer, the largest challenge will be the complete makeover of the energy grid in order to make space for electric vehicles.

In the general polluting picture, industry is still the largest polluter - not counting for the transport which is mixed with heavy and light vehicles which operate for the industry. While the impact from the great recession can still be seen in the historical emission landscape; GDPs have recovered since 2008, indicating a slow shift towards greener and more efficient technologies being adopted.

Far from net zero, the slow decline in emissions can still be seen due to economic shocks more than real change in drive towards cleaner resources. And that is in Europe, which has been said to champion the movement towards stopping climate change.

```{r breakdown for sectors (europe wide), warning=FALSE, message=FALSE, include=FALSE}

em_sector_raw<-readRDS("Data/sectors_breakdown.rds")
em_sector<- em_sector_raw %>% select(-c(Format_name,Sector_code,Unit,Notation,PublicationDate,DataSource))
# em_sector_raw%>% select(Unit,Pollutant_name)
unique(em_sector$Pollutant_name)

# Aggregate by years, and summary all emissions:
em_sec_year<-data.frame(Consumed=tapply(em_sector$emissions,list(em_sector$Year), function(x) {sum(x,na.rm=TRUE)}))
em_sec_year<-rownames_to_column(em_sec_year,"Year")

ggplot(em_sec_year,aes(x=Year,y=Consumed))+geom_col()+theme(axis.text.x = element_text(angle = 45,hjust=1))

#Aggregate by sectors:

em_sec_sec<-data.frame(Consumed=tapply(em_sector$emissions,list(em_sector$Sector_name), function(x) {sum(x,na.rm=TRUE)}))
em_sec_sec<-rownames_to_column(em_sec_sec,"Sectors")

ggplot(em_sec_sec,aes(x=Sectors,y=Consumed))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 45,hjust=1),panel.grid = element_blank())


#Main charts to create::


```



```{r warning=FALSE, message=FALSE, echo=FALSE}
# 1.x.(1,2,3,4) - energy production
sec_energy_prod<- em_sector %>% filter(Sector_name %in% c("1.A.1 - Energy Industries",
                                                     "1.A.2 - Manufacturing Industries and Construction",
                                                     "1.A.3 - Transport",
                                                     "1.A.4 - Other Sectors",
                                                     "1.A.5 - Other Other Sectors",
                                                     "2 - Industrial Processes and Product Use",
                                                     "3 - Agriculture")) %>% 
                    select(-c(Parent_sector_code,Pollutant_name)) %>%
                    mutate(Sector_name= as.factor(Sector_name),
                           Sector_name=fct_collapse(Sector_name," Other Sectors"=
                                                      c("1.A.4 - Other Sectors","1.A.5 - Other Other Sectors"))) %>% group_by(Country_code,Year,Sector_name) %>% summarise(Emissions = sum(emissions)) %>% ungroup(Country_code,Year,Sector_name)


levels(sec_energy_prod$Sector_name)=c("Energy industry","Manufacturing & construction","Transport","Other","Industrial processes","Agriculture")

plot_3.1<- ggplot(sec_energy_prod %>% filter(Country_code=="EUA") ,
                  aes(x= as.integer(Year)+1, y=Emissions/1000, group=Sector_name,col=Sector_name)) + 
                  geom_line() + 
                  geom_point(alpha=.5) +  
                  labs(x="Years",
                       y=expression(paste('Emissions (',1000,'s Gigagrams)')),
                       title="Cummulative emissions by sector",
                       col="Sectors") + 
                  theme_bw() + 
                  theme(axis.text.x = element_text(angle = 45,hjust=1), panel.grid = element_blank())+
                  ylim(0,3500)
plot_3.1
```

```{r  warning=FALSE, message=FALSE, echo=FALSE}
#   1.3. (a,bi.ii.iii.iv.v,c,d,e) - modes of transportation (specially if it's seen as main pollutant)
sec_energy_transport<- em_sector %>% filter(Sector_name %in% c("1.A.3.a - Domestic Aviation",
                                                     "1.A.3.b.i - Cars",
                                                     "1.A.3.b.ii - Light duty trucks",
                                                     "1.A.3.b.iii - Heavy duty trucks and buses",
                                                     "1.A.3.b.iv - Motorcycles",
                                                     "1.A.3.b.v - Other Road Transportation",
                                                     "1.A.3.c - Railways",
                                                     "1.A.3.d - Domestic Navigation",
                                                     "1.A.3.e - Other Transportation")) %>% 
                    select(-c(Parent_sector_code,Pollutant_name)) %>%
                    mutate(Sector_name= as.factor(Sector_name),
                           Sector_name=fct_collapse(Sector_name," Other transports"=
                                                      c("1.A.3.b.iv - Motorcycles",
                                                        "1.A.3.b.v - Other Road Transportation",
                                                        "1.A.3.c - Railways",
                                                        "1.A.3.d - Domestic Navigation",
                                                        "1.A.3.a - Domestic Aviation",
                                                        "1.A.3.e - Other Transportation"))
                           ) %>% group_by(Country_code,Year,Sector_name) %>% 
                                 summarise(Emissions = sum(emissions)) %>%  
                                 ungroup(Country_code,Year,Sector_name)

levels(sec_energy_transport$Sector_name)=c("Other transports","Cars","Light duty trucks",
                                            "Heavy duty trucks and buses")

plot_3.2<-ggplot(sec_energy_transport %>% filter(Country_code=="EUA") ,
                 aes(x=as.integer(Year)+1, y=Emissions/1000, group=Sector_name,col=Sector_name)) +
                 geom_line() +
                 geom_point(alpha=.5)+
                 labs(x="Years",
                     y=expression(paste('Emissions (',1000,'s Gigagrams)')),
                     title="European Cummulative emissions by transport", 
                     col="Sectors") + 
                 theme_bw() + 
                 theme(axis.text.x = element_text(angle = 45,hjust=1),
                       panel.grid = element_blank())+
            ylim(0, max(sec_energy_transport$Emissions/1000,na.rm=TRUE)+100)

plot_3.2

```

```{r  warning=FALSE, message=FALSE, echo=FALSE}



#   1.3. (a,bi.ii.iii.iv.v,c,d,e) - modes of transportation (specially if it's seen as main pollutant)
sec_energy_residential<- em_sector %>% filter(Sector_name %in% c("1.A.4.a - Commercial/Institutional",
                                                               "1.A.4.b - Residential",
                                                               "1.A.4.c - Agriculture/Forestry/Fishing",
                                                               "1.A.2 - Manufacturing Industries and Construction",
                                                               "2 - Industrial Processes and Product Use",
                                                               "1.A.3 - Transport",
                                                               "3 - Agriculture")) %>% 
                    select(-c(Parent_sector_code,Pollutant_name)) %>%
                    mutate(Sector_name= as.factor(Sector_name),
                           Sector_name=fct_collapse(Sector_name,"Residential/Commercial"= 
                                                          c("1.A.4.a - Commercial/Institutional","1.A.4.b - Residential")),
                           Sector_name=fct_collapse(Sector_name,"Agriculture"=
                                                          c("1.A.4.c - Agriculture/Forestry/Fishing","3 - Agriculture")),
                           Sector_name=fct_collapse(Sector_name,"Industry"=
                                                          c("1.A.2 - Manufacturing Industries and Construction",
                                                               "2 - Industrial Processes and Product Use"))) %>% group_by(Country_code,Year,Sector_name) %>% summarise(Emissions = sum(emissions)) %>%  
                                 ungroup(Country_code,Year,Sector_name)

levels(sec_energy_residential$Sector_name)=c("Industry","Transport","Residential/Commercial",
                                            "Agriculture")

plot_3.3 <- ggplot(sec_energy_residential %>% filter(Country_code=="EUA") ,
                 aes(x=as.integer(Year)+1, y=Emissions/1000, group=Sector_name,col=Sector_name)) +
                 geom_line() + 
                 geom_point(alpha=.5)+
                 theme_bw() + 
                 theme(axis.text.x = element_text(angle = 45,hjust=1),
                       panel.grid = element_blank()) +
                 labs(x="Years",
                      y=expression(paste('Emissions (',1000,'s Gigagrams)')),
                      title="European Cummulative emissions by sectors",
                      col="Sectors")+
                  ylim(0, 2750)
                       

plot_3.3

```

Country wide, the relative pollution compared to total energy generation is quite uniform across countries, with eastern european countries lagging slightly behind, mainly through their highly polluting coal and oil intensive practices. 

Ireland too is the European country which In a stark manner is performing worse in the metric. This can be traced back to their lack of investment in renewable technologies and heavy oil dependence.

Northern-european countries, which have typically been ahead of the curve in socio-economic advances and equality, are equally ahead in terms of their relative pollution to gigawatt production, thanks mainly to the large hydroelectric resources which mainly suffice to power their sparsely populated countries.

```{r sorting the datasets, warning=FALSE, message=FALSE, echo=FALSE}

#bring the data for the map
world = map_data('world')  %>% mutate(region = ifelse(region=="UK","United Kingdom",region))

europe = c((dictionary_countries %>% 
            mutate(Country=ifelse(Country=="United Kingdom (Convention)","United 
                                  Kingdom",Country),Country_codes=ifelse(Country_codes=="GE","EL",Country_codes)) %>% 
            filter(Country != c("EU-27+UK","EU (KP)","EU-27")))$Country)

europe_codes = c((dictionary_countries %>% 
            mutate(Country=ifelse(Country=="United Kingdom (Convention)","United 
                              Kingdom",Country),Country_codes=ifelse(Country_codes=="GE","EL",Country_codes)) %>% 
              filter(Country != c("EU-27+UK","EU (KP)","EU-27")))$Country_codes)


# Extrapolate the data of the UK - repeat last value:
a<-data_prod %>% mutate(Energy=OBS_VALUE/10^3) %>% 
                filter(Fuel=="Total",TIME_PERIOD=="2020-01-01", geo %in% europe_codes) %>% 
                select(-OBS_VALUE)

b<-data.frame(Fuel="Total",geo="UK",TIME_PERIOD="2020-01-01",Energy = data_prod %>% 
                filter(geo=="UK",TIME_PERIOD=="2019-01-01",Fuel=="Total")%>% 
                mutate(Energy=OBS_VALUE/10^3)%>% 
                select(Energy))

# bring the data for the filling, energy and pollution data:
data_prod_uk<- rbind(a,b)

total_energy<- left_join(data_prod_uk, dictionary_countries %>% 
                           filter(Country != c("EU-27+UK","EU (KP)","EU-27")) %>% 
                           transmute(geo=Country_codes,Country=Country),by="geo") %>% 
                          select(-geo)

fill_pol_en<-left_join(eur_em  %>% 
                          mutate(Country = Geographic_entity, Pollution = eur_em$'2020' ) %>% 
                          filter( Country != "EU-27+UK",Country != "EU (KP)",Country != "EU-27")%>% 
                          select(Country,Pollution),
                  total_energy, by= "Country") %>%   
              transmute(Country,Pollution=Pollution/Energy,region=Country,Fuel,year=TIME_PERIOD,Pol=Pollution,En=Energy)

```


```{r plotting, warning=FALSE, message=FALSE, echo=FALSE}
eur = world[world$region %in% c(fill_pol_en$region,"Iceland","Norway","Turkey","Ukraine","Moldova","Belarus"), ] 
eur <-eur %>% filter(!subregion %in%  c("Jan Mayen","Svalbard"))

clear_plot_background = theme(
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank())

map_plot <- ggplot(data = eur, 
                  mapping = aes(x = long, y = lat, group = group)) +
  coord_map('gilbert') + 
  geom_polygon(colour = 'black', fill = 'white')  + clear_plot_background



eur_em_map = eur %>% 
  left_join(fill_pol_en, by = 'region') %>% drop_na(Country)


map_plot + geom_polygon(data = eur_em_map,  #plot bear population data
               aes(x = long, 
                   y = lat, 
                   group = group, 
                   fill = Pollution), 
               colour = 'white') +
  geom_polygon(colour = 'black', fill = NA) +  #plot country outlines
  scale_fill_viridis(limits = c(0,0.4), breaks = c(0, 0.1, 0.2, 0.3, 0.4),
    guide = guide_colourbar(nbin = 100, draw.ulim = FALSE, draw.llim = FALSE))+
  ft_theme()+ 
  theme(
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()) +
  labs(x="Years",
       y=expression(paste('Emissions (',1000,'s Gigagrams)')),
       title="European Cummulative emissions by sectors",
       fill=expression(paste("Pollution/Energy (MTC",O[2],"/TWE)")))
```

While pacts and politicians seem hopeful and promise to achieve the deadlines of net zero in the next 20 years, the current situation of the energy grid and energy production remains clearly unbalanced towards fossil fuels.

Chances such as the working from home revolution coming out from the pandemic, and now the huge commodities rise due to the military conflict in eastern Europe may help provide the economic incentives necessary to flip on their head total energy production.

Until then, Europe and the world will still have a lot of work to do before stopping the 2 degree rise.

